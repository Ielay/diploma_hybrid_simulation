# Дипломная работа: гибридный симулятор мультиагентной системы с визуализацией, асинхронным взаимодействием роботов и возможностью подключения реальных объектов

Здесь и далее представлены инструкции для сборки и запуска в ОС Ubuntu версии 20.04. 

---
## Версии компонентов
---
В системе использовались сервисы со следующими версиями:
1. Webots - 2021a (deb пакет можно взять [здесь](https://github.com/cyberbotics/webots/releases/download/R2021a/webots_2021a_amd64.deb))
2. JADE - 4.5.0 (zip-архив приложен в данном репозитории)
3. ROS - используется ROS версии noetic (инструкцию по установке можно найти [здесь](http://wiki.ros.org/noetic/Installation/Ubuntu))

---
## Сборка компонентов системы
---
Считаем, что к этому шагу все необходимые дистрибутивы указанных выше версий уже установлены в системе

### Сборка jar контейнера JADE

В качестве менеджера пакетов использован `maven`.

Так как пакет с JADE не был найден мной в maven-central репозитории, перед началом сборки необходимо добавить его вручную в локальный maven репозиторий `.m2`. Для этого необходимо взять jar архив с библиотеками JADE и положить его по следующему пути: `~/.m2/repository/jade/jade/4.5.0/jade-4.5.0.jar`. После этого со сборкой не должно быть проблем.

Запуск сборки из директории с исходным кодом JADE контейнера (директория `./jade_service/jade_webots`):
 ```bash
 mvn clean package
 ```

 После сборки появится директория `./target`, внутри которой можно найти `jade_container.jar` и директорию `dependency_jars`, содержащую необходимые зависимости для запуска контейнера JADE.

### Сборка ROS узла с Webots

Запускаем из директории с исходниками узла Webots (корневая директория проекта):
```bash
catkin build
```

Должны появиться директории `build` и `devel`, в последней находится файл с настройками 

---
## Запуск системы
---

### Запуск компонентов ROS
1. Исполняем `setup.bash` файл, для того, чтобы загрузить переменные окружения ROS:
    ```bash
    source /opt/ros/noetic/setup.bash
    ```
2. Поднимаем ros master:
    ```bash
    roscore
    ```
3. Поднимаем rosbridge (websocket server): 
    ```bash
    roslaunch rosbridge_server rosbridge_websocket.launch
    ```

### Запуск контейнеров JADE

В одной поднятой JADE платформе должен обязательно присутствовать ровно один main container.

Для упрощения запуска контейнера существует скрипт `run_container.bash`. Он содержит следующие переменные:
+ **FIRST_ROBOT_ID** - уникальный id первого агента в контейнере
+ **ROBOTS_IN_CONTAINER** - количество роботов в контейнере. При этом, id первого робота в контейнере будет равен `FIRST_ROBOT_ID`, а последнего - `FIRST_ROBOT_ID + ROBOTS_IN_CONTAINER - 1` 
+ **ROS_BRIDGE_URL** - URL, по которому доступ rosbridge
+ **IS_MAIN_CONTAINER** - является ли поднимаемый контейнер главным
+ **JADE_MAIN_CONTAINER_HOST** - IP/hostname машины с главным контейнером 
+ **JADE_MAIN_CONTAINER_PORT** - порт, по которому осуществляется доступ к главному контейнеру (по-умолчанию `10098`)

Запуск контейнера через скрипт с указанными аргументами:
```bash
./run_container.bash
```

### Запуск симулятора Webots с симуляцией, как узла ROS

1. Исполняем скрипт с настройками окружения узла:
```bash
source devel/setup.bash
```
2. Получаем путь до файлов Webots в системе:
```bash
which webots
```
3. Добавляем в переменную окружения путь до файлов Webots в системе. В моём случае, это `/usr/local/bin/webots`:
```bash
export WEBOTS_HOME=/usr/local/bin
``` 
4. Запускаем Webots, как узел ROS, через `roslaunch`. Указываем в качестве аргумента launch файл с конкретной симуляцией:
```bash
roslaunch webots_logic webots_ros_25_robots_jade_python.launch
```